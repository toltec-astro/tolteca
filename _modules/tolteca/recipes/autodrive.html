
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tolteca.recipes.autodrive &#8212; tolteca v1.1.1.dev0+g81c4624.d20220216</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">TolTECA</span><span id="logotext2"></span><span id="logotext3">:docs</span></a>
  <ul>
    
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">tolteca v1.1.1.dev0+g81c4624.d20220216</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tolteca.recipes.autodrive</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>

<span class="c1"># Author:</span>
<span class="c1">#   Zhiyuan Ma</span>

<span class="sd">&quot;&quot;&quot;This recipe implements the &quot;autodrive&quot; procedure to determine the best</span>
<span class="sd">drive attenuations for the KIDs.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">tolteca.recipes</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">tolteca.datamodels.toltec</span> <span class="kn">import</span> <span class="n">BasicObsDataset</span>
<span class="kn">from</span> <span class="nn">tollan.utils.cli.multi_action_argparser</span> <span class="kn">import</span> \
        <span class="n">MultiActionArgumentParser</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tollan.utils.mpl</span> <span class="kn">import</span> <span class="n">save_or_show</span>
<span class="kn">from</span> <span class="nn">tollan.utils.slice</span> <span class="kn">import</span> <span class="n">parse_slice</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="c1"># from kneed import KneeLocator</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>


<div class="viewcode-block" id="load_autodrive_data"><a class="viewcode-back" href="../../../api/tolteca.recipes.autodrive.load_autodrive_data.html#tolteca.recipes.autodrive.load_autodrive_data">[docs]</a><span class="k">def</span> <span class="nf">load_autodrive_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a dataset, try load all the necessary data to run the autodrive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset: BasicObsDataset</span>
<span class="sd">        The input dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load autodrive data from: </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># split the dataset for tunes and reduced files</span>
    <span class="n">targs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;fileext==&quot;nc&quot; &amp; filesuffix==&quot;targsweep&quot;&#39;</span><span class="p">)</span>
    <span class="n">calibs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;fileext==&quot;txt&quot; &amp; filesuffix==&quot;targsweep&quot;&#39;</span><span class="p">)</span>
    <span class="c1"># Read the sweep object from the file IO object. A TolTEC tune file</span>
    <span class="c1"># contains multipe sweep blocks, and here we read the last one using the</span>
    <span class="c1"># `sweeploc` method.</span>
    <span class="n">targs</span><span class="p">[</span><span class="s1">&#39;data_obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targs</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
    <span class="n">calibs</span><span class="p">[</span><span class="s1">&#39;mdl_obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calibs</span><span class="o">.</span><span class="n">read_all</span><span class="p">()</span>
    <span class="n">join_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;roachid&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnum&#39;</span><span class="p">,</span> <span class="s1">&#39;subobsnum&#39;</span><span class="p">,</span> <span class="s1">&#39;scannum&#39;</span><span class="p">]</span>

    <span class="n">tbl</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
            <span class="n">targs</span><span class="o">.</span><span class="n">index_table</span><span class="p">,</span> <span class="n">calibs</span><span class="o">.</span><span class="n">index_table</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">join_keys</span><span class="p">,</span>
            <span class="n">join_type</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">targs</span> <span class="o">=</span> <span class="n">BasicObsDataset</span><span class="p">(</span><span class="n">index_table</span><span class="o">=</span><span class="n">tbl</span><span class="p">,</span> <span class="n">bod_list</span><span class="o">=</span><span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;data_obj&#39;</span><span class="p">])</span>
    <span class="c1"># targs = targs.right_join(</span>
    <span class="c1">#         calibs.load_data(lambda fo: fo),</span>
    <span class="c1">#         join_keys, [(&#39;data_obj&#39;, &#39;mdl_obj&#39;), ], )</span>
    <span class="c1"># join the mdls to swps</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;targs: </span><span class="si">{</span><span class="n">targs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">targs</span></div>


<div class="viewcode-block" id="find_best_a_naive"><a class="viewcode-back" href="../../../api/tolteca.recipes.autodrive.find_best_a_naive.html#tolteca.recipes.autodrive.find_best_a_naive">[docs]</a><span class="k">def</span> <span class="nf">find_best_a_naive</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_flat</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple brutal force finder of the best atten value.</span>

<span class="sd">    The algorithm goes through the values in decreasing</span>
<span class="sd">    order and looks for the first point hat has y higher by</span>
<span class="sd">    some factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="c1"># sort in descending order so that the flat</span>
    <span class="c1"># section is at start. the a</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_flat</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;unable to find best a: not enough data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">n_flat</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># the running index</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">yy</span><span class="p">[:</span><span class="n">ii</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yy</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">aa</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;unable to find best a: no more value to traverse.&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="find_best_a_naive2"><a class="viewcode-back" href="../../../api/tolteca.recipes.autodrive.find_best_a_naive2.html#tolteca.recipes.autodrive.find_best_a_naive2">[docs]</a><span class="k">def</span> <span class="nf">find_best_a_naive2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_init</span><span class="p">,</span> <span class="n">n_sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple brutal force finder of the best atten value.</span>

<span class="sd">    The algorithm goes through the values in decreasing</span>
<span class="sd">    order and looks for the first point hat has y higher by</span>
<span class="sd">    some factor of the standard deviation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="c1"># sort in descending order so that the flat</span>
    <span class="c1"># section is at start. the a</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_init</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;unable to find best a: not enough data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">n_init</span>  <span class="c1"># the running index</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yy</span><span class="p">[:</span><span class="n">ii</span><span class="p">])</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">yy</span><span class="p">[:</span><span class="n">ii</span><span class="p">])</span>

    <span class="k">while</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">yy</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">n_sigma</span> <span class="o">*</span> <span class="n">sig</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">aa</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;unable to find best a: no more value to traverse.&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="find_best_a_naive3"><a class="viewcode-back" href="../../../api/tolteca.recipes.autodrive.find_best_a_naive3.html#tolteca.recipes.autodrive.find_best_a_naive3">[docs]</a><span class="k">def</span> <span class="nf">find_best_a_naive3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_flat</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">n_accept</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple brutal force finder of the best atten value.</span>

<span class="sd">    The algorithm goes through the values in decreasing</span>
<span class="sd">    order and looks for the first group of points that have y higher by</span>
<span class="sd">    some factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="c1"># sort in descending order so that the flat</span>
    <span class="c1"># section is at start. the a</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_flat</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;unable to find best a: not enough data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yy</span><span class="p">[:</span><span class="n">n_flat</span><span class="p">])</span>

    <span class="n">cands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yy</span> <span class="o">&gt;</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cands</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">cands</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">n_accept</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">aa</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;unable to find best a: no more value to traverse.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="autodrive"><a class="viewcode-back" href="../../../api/tolteca.recipes.autodrive.autodrive.html#tolteca.recipes.autodrive.autodrive">[docs]</a><span class="k">def</span> <span class="nf">autodrive</span><span class="p">(</span>
        <span class="n">targs</span><span class="p">,</span> <span class="n">toneloc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output_ref_atten</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    <span class="n">swps</span> <span class="o">=</span> <span class="n">targs</span><span class="p">[</span><span class="s1">&#39;data_obj&#39;</span><span class="p">]</span>
    <span class="n">mdls</span> <span class="o">=</span> <span class="n">targs</span><span class="p">[</span><span class="s1">&#39;mdl_obj&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">swp</span><span class="p">,</span> <span class="n">mdl</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">swps</span><span class="p">,</span> <span class="n">mdls</span><span class="p">)):</span>
        <span class="n">swp</span><span class="o">.</span><span class="n">mdl</span> <span class="o">=</span> <span class="n">mdl</span>
        <span class="n">swp</span><span class="o">.</span><span class="n">S21_mdl</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">swp</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
        <span class="c1"># TODO sort out the unit stuff here</span>
        <span class="n">swp</span><span class="o">.</span><span class="n">S21_derot</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">derotate</span><span class="p">(</span>
                <span class="n">swp</span><span class="o">.</span><span class="n">S21</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">),</span> <span class="n">swp</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">adu</span>
        <span class="n">swp</span><span class="o">.</span><span class="n">adiqs_derot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">swp</span><span class="o">.</span><span class="n">diqs_df</span><span class="p">(</span>
            <span class="n">swp</span><span class="o">.</span><span class="n">S21_derot</span><span class="p">,</span> <span class="n">swp</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">toneloc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">toneloc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">toneloc</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="n">toneloc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">toneloc</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">swps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">S21</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">tis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">toneloc</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">toneloc</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">toneloc</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">toneloc</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tones: </span><span class="si">{</span><span class="n">toneloc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">n_tis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tis</span><span class="p">)</span>
    <span class="n">n_swps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">swps</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_tis=</span><span class="si">{</span><span class="n">n_tis</span><span class="si">}</span><span class="s2"> n_swps=</span><span class="si">{</span><span class="n">n_swps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">a_drvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="n">n_swps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">a_tots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="n">n_swps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">Qrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="n">n_swps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">frs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="n">n_swps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">adiqs_derot_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="n">n_swps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">data_extra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="n">n_swps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ti</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">swp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="n">tis</span><span class="p">),</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">swps</span><span class="p">)):</span>
        <span class="n">a_drvs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_drv</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;atten_drive&#39;</span><span class="p">]</span>
        <span class="n">a_tots</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_tot</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;atten_sense&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">swp</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;atten_drive&#39;</span><span class="p">]</span>
        <span class="c1"># compute abs of derotated d21 and find the maximum</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">iqs</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">S21</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">iqs_mdl</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">S21_mdl</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">iqs_derot</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">S21_derot</span><span class="p">[</span><span class="n">ti</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
        <span class="c1"># adiqs_derot = swp.adiqs_derot[ti, :]</span>
        <span class="n">adiqs_derot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">iqs_derot</span><span class="p">,</span> <span class="n">fs</span><span class="p">))</span>
        <span class="c1"># we only find the max within one fwhm of the resonance</span>
        <span class="n">Qrs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qr</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Qr</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
        <span class="n">frs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">swp</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fr</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="n">fr</span> <span class="o">/</span> <span class="n">swp</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Qr</span><span class="p">[</span><span class="n">ti</span><span class="p">]</span>
        <span class="n">flim</span> <span class="o">=</span> <span class="p">(</span><span class="n">fr</span> <span class="o">-</span> <span class="n">fwhm</span><span class="p">),</span> <span class="p">(</span><span class="n">fr</span> <span class="o">+</span> <span class="n">fwhm</span><span class="p">)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="p">(</span><span class="n">fs</span> <span class="o">&gt;=</span> <span class="n">flim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fs</span> <span class="o">&lt;</span> <span class="n">flim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fm</span><span class="p">):</span>
            <span class="n">adiqs_derot_max</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">adiqs_derot</span><span class="p">[</span><span class="n">fm</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adiqs_derot_max</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">data_extra</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">fs</span><span class="p">,</span> <span class="n">iqs</span><span class="p">,</span> <span class="n">iqs_mdl</span><span class="p">,</span> <span class="n">iqs_derot</span><span class="p">,</span> <span class="n">adiqs_derot</span><span class="p">,</span>
                <span class="n">Qr</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">flim</span><span class="p">,</span> <span class="n">fm</span>
                <span class="p">)</span>

    <span class="c1"># reduce the swps to get the best a_drv</span>
    <span class="c1"># this is done by looking from a &quot;flat&quot; section</span>
    <span class="c1"># in the adiqs_derot_max vs a_drvs, and find the</span>
    <span class="c1"># minimum a_drv that have adiqs_derot_max higher by</span>
    <span class="c1"># some factor of the &quot;flat&quot; section.</span>
    <span class="n">a_drv_bests</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="c1"># finder = find_best_a_naive2</span>
    <span class="c1"># finder_kwargs = dict(</span>
    <span class="c1">#         n_init=min(10, len(a_drvs) / 5),</span>
    <span class="c1">#         n_sigma=3,</span>
    <span class="c1">#         )</span>
    <span class="n">finder</span> <span class="o">=</span> <span class="n">find_best_a_naive3</span>
    <span class="n">finder_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">n_flat</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_drvs</span><span class="p">)</span> <span class="o">//</span> <span class="mi">5</span><span class="p">),</span>
            <span class="n">thresh</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
            <span class="n">n_accept</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;finder=</span><span class="si">{</span><span class="n">finder</span><span class="si">}</span><span class="s2"> kwargs=</span><span class="si">{</span><span class="n">finder_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tis</span><span class="p">):</span>
        <span class="c1"># a_drv_bests[i] = find_best_a_naive(</span>
        <span class="c1">#         a_drvs[i], adiqs_derot_max[i],</span>
        <span class="c1">#         n_flat=5,</span>
        <span class="c1">#         thresh=1.2,</span>
        <span class="c1">#         )</span>
        <span class="n">a_drv_bests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">finder</span><span class="p">(</span>
                <span class="n">a_drvs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">adiqs_derot_max</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="o">**</span><span class="n">finder_kwargs</span>
                <span class="p">)</span>
        <span class="c1"># kneedle = KneeLocator(</span>
        <span class="c1">#         a_drvs, adiqs_derot_max,</span>
        <span class="c1">#         S=1.0,</span>
        <span class="c1">#         curve=&#39;convex&#39;,</span>
        <span class="c1">#         direction=&#39;decreasing&#39;,</span>
        <span class="c1">#         interp_method=&#39;polynomial&#39;)</span>
        <span class="c1"># a_drv_bests[i] = a_drv_best = knee</span>
    <span class="c1"># compute autodrive cor table</span>
    <span class="k">if</span> <span class="n">output_ref_atten</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># use the ref atten at 90 percentile</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">a_drv_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">a_drv_bests</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_drv_bests</span><span class="p">)],</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;a_drv_ref=</span><span class="si">{</span><span class="n">a_drv_ref</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_drv_ref</span> <span class="o">=</span> <span class="n">output_ref_atten</span>
    <span class="n">ampcors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_tis</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tis</span><span class="p">):</span>
        <span class="n">a_drv</span> <span class="o">=</span> <span class="n">a_drv_bests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ampcor</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">((</span><span class="n">a_drv_ref</span> <span class="o">-</span> <span class="n">a_drv</span><span class="p">)</span> <span class="o">/</span> <span class="mf">20.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ampcor</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ampcor</span><span class="p">):</span>
            <span class="n">ampcor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">ampcors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampcor</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="c1"># fo.write(f&quot;# a_drv_ref={a_drv_ref} dB\n&quot;)</span>
            <span class="k">for</span> <span class="n">ampcor</span> <span class="ow">in</span> <span class="n">ampcors</span><span class="p">:</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ampcor</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.a_drv&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a_drv_bests</span><span class="p">:</span>
                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">ampcor_extra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ampcors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c1"># ampcor_extra = np.sqrt(np.sum(ampcors[i] ** 2)) / len(ampcors)</span>
    <span class="n">a_drv_extra</span> <span class="o">=</span> <span class="o">-</span><span class="mf">20.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ampcor_extra</span><span class="p">)</span>
    <span class="n">a_drv_common</span> <span class="o">=</span> <span class="n">a_drv_ref</span> <span class="o">+</span> <span class="n">a_drv_extra</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;a_drv_common=</span><span class="si">{</span><span class="n">a_drv_common</span><span class="si">}</span><span class="s2"> (extra=</span><span class="si">{</span><span class="n">a_drv_extra</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># make plots of the failed cases</span>
    <span class="c1"># maximum number of panels is 10</span>
    <span class="n">i_failed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_drv_bests</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># i_good = np.where(~np.isnan(a_drv_bests))[0]</span>
    <span class="n">n_failed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_failed</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_tones with failed autodrive: </span><span class="si">{</span><span class="n">n_failed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># i_plot = list(i_failed) + list(i_good[:n_failed])</span>
    <span class="n">i_plot</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">panel_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_plot</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">n_rows</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">panel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">panel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">),</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_plot</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># (I, Q)</span>
        <span class="n">bx</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># (I, Q) derotated</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># adiqs</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># max(adiqs) vs a_drv</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># Qr vs a_drv</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># fr vs a_drv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_swps</span><span class="p">):</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">swps</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;obsnum&#39;</span><span class="p">]</span>
            <span class="n">a_drv</span> <span class="o">=</span> <span class="n">a_drvs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">a_tot</span> <span class="o">=</span> <span class="n">a_tots</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">fs</span><span class="p">,</span> <span class="n">iqs</span><span class="p">,</span> <span class="n">iqs_mdl</span><span class="p">,</span> <span class="n">iqs_derot</span><span class="p">,</span> <span class="n">adiqs_derot</span><span class="p">,</span> \
                <span class="n">Qr</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">flim</span><span class="p">,</span> <span class="n">fm</span> <span class="o">=</span> <span class="n">data_extra</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">iqs</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">iqs</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;$</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="se">\\</span><span class="s1"> A_</span><span class="se">{{</span><span class="s1">drive</span><span class="se">}}</span><span class="s1">=</span><span class="si">{</span><span class="n">a_drv</span><span class="si">}</span><span class="s1">,&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1"> A_</span><span class="se">{{</span><span class="s1">tot</span><span class="se">}}</span><span class="s1">=</span><span class="si">{</span><span class="n">a_tot</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">iqs_mdl</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">iqs_mdl</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">bx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">iqs_derot</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">iqs_derot</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">cx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">adiqs_derot</span><span class="p">)</span>
            <span class="n">cx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">flim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#cccccc&#39;</span><span class="p">)</span>
            <span class="n">cx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">flim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#cccccc&#39;</span><span class="p">)</span>
        <span class="c1"># trend</span>
        <span class="c1"># assert tis[i] == i</span>
        <span class="n">dx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">a_drvs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">adiqs_derot_max</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;tone id=</span><span class="si">{</span><span class="n">tis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">a_drv_best</span> <span class="o">=</span> <span class="n">a_drv_bests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dx</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">a_drv_best</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#000000&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;$A_</span><span class="se">{{</span><span class="s1">drv, best</span><span class="se">}}</span><span class="s1">=</span><span class="si">{</span><span class="n">a_drv_best</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">dx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="n">ex</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">a_drvs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Qrs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">fx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">a_drvs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">frs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">fig2</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">bx</span> <span class="o">=</span> <span class="n">axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">a_drv_bests</span><span class="p">)</span>
    <span class="n">bx</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">frs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tis</span><span class="p">)],</span>  <span class="n">ampcors</span><span class="p">)</span>
    <span class="n">fig2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">save_or_show</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span> <span class="s1">&#39;fig_autodrive.png&#39;</span><span class="p">,</span> <span class="n">window_type</span><span class="o">=</span><span class="s1">&#39;scrollable&#39;</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">panel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">panel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../api/tolteca.recipes.autodrive.main.html#tolteca.recipes.autodrive.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">maap</span> <span class="o">=</span> <span class="n">MultiActionArgumentParser</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run autodrive.&quot;</span>
            <span class="p">)</span>
    <span class="n">act_index</span> <span class="o">=</span> <span class="n">maap</span><span class="o">.</span><span class="n">add_action_parser</span><span class="p">(</span>
            <span class="s1">&#39;index&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Build an index table that have tones&quot;</span>
            <span class="s2">&quot; matched for a set of tune files&quot;</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;files&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The files to use&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--select&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;COND&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A selection predicate, e.g.,:&#39;</span>
            <span class="s1">&#39;&quot;(obsnum&gt;8900) &amp; (roachid==3) &amp; (fileext==&quot;nc&quot;)&quot;&#39;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT_FILE&quot;</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output filename&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_index</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, overwrite the existing index file&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@act_index</span><span class="o">.</span><span class="n">parser_action</span>
    <span class="k">def</span> <span class="nf">index_action</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">option</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;output file </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> exists, use -f to overwrite&quot;</span><span class="p">)</span>
        <span class="c1"># This function is called when `index` is specified in the cmd</span>
        <span class="c1"># Collect the dataset from the command line arguments</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">BasicObsDataset</span><span class="o">.</span><span class="n">from_files</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="c1"># Apply any selection filtering</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">select</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
        <span class="c1"># Run the tone matching algo.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_autodrive_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="c1"># Dump the results.</span>
        <span class="c1"># dataset.write_index_table(</span>
        <span class="c1">#         option.output, overwrite=option.overwrite,</span>
        <span class="c1">#         format=&#39;ascii.commented_header&#39;)</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>

    <span class="n">act_run</span> <span class="o">=</span> <span class="n">maap</span><span class="o">.</span><span class="n">add_action_parser</span><span class="p">(</span>
            <span class="s1">&#39;run&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run autodrive&quot;</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--select&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;COND&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;A selection predicate, e.g.,:&#39;</span>
            <span class="s1">&#39;&quot;(obsnum&gt;8900) &amp; (roachid==3) &amp; (fileext==&quot;nc&quot;)&quot;&#39;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The input filename, created by the &quot;index&quot; action.&#39;</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--tones&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s1">&#39;:10&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The tones to examine. Default is the first 10.&#39;</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--output_ref_atten&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The output reference driving atten.&#39;</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--plot&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Make plots.&#39;</span>
            <span class="p">)</span>
    <span class="n">act_run</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The output amplitude correction filename.&#39;</span>
            <span class="p">)</span>

    <span class="nd">@act_run</span><span class="o">.</span><span class="n">parser_action</span>
    <span class="k">def</span> <span class="nf">run_action</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">input_</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">BasicObsDataset</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">input_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
        <span class="n">autodrive</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span>
                <span class="n">toneloc</span><span class="o">=</span><span class="n">parse_slice</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">tones</span><span class="p">),</span>
                <span class="n">output_ref_atten</span><span class="o">=</span><span class="n">option</span><span class="o">.</span><span class="n">output_ref_atten</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="n">option</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>

    <span class="n">act_collect</span> <span class="o">=</span> <span class="n">maap</span><span class="o">.</span><span class="n">add_action_parser</span><span class="p">(</span>
            <span class="s1">&#39;collect&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Collect autodrive result&quot;</span>
            <span class="p">)</span>
    <span class="n">act_collect</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;files&quot;</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILE&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The files to use&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_collect</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The output drive attenution file.&#39;</span>
            <span class="p">)</span>
    <span class="n">act_collect</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, overwrite the existing index file&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">act_collect</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--plot&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Make plots.&#39;</span>
            <span class="p">)</span>
    <span class="n">act_collect</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;--save_plot&#39;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save plot.&#39;</span>
            <span class="p">)</span>

    <span class="nd">@act_collect</span><span class="o">.</span><span class="n">parser_action</span>
    <span class="k">def</span> <span class="nf">collect_action</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">option</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;output file </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> exists, use -f to overwrite&quot;</span><span class="p">)</span>

        <span class="n">ps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nw&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;p</span><span class="si">{</span><span class="n">p</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">]</span>
        <span class="c1"># sort the files</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">option</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">nw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;toltec&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nw</span><span class="p">,</span> <span class="n">filepath</span><span class="p">))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nw</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.no_header&#39;</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;col1&#39;</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">nw</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ps</span><span class="p">])</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.commented_header&#39;</span><span class="p">)</span>
        <span class="n">cmd_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.cmd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cmd_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-AttenDriveCmd[</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;nw&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p95&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;set ToltecBackend </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ps</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;NW </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;nw&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best driving atten. (dB)&#39;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">save_or_show</span><span class="p">(</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                    <span class="n">save</span><span class="o">=</span><span class="n">option</span><span class="o">.</span><span class="n">save_plot</span><span class="p">)</span>

    <span class="n">option</span> <span class="o">=</span> <span class="n">maap</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">maap</span><span class="o">.</span><span class="n">bootstrap_actions</span><span class="p">(</span><span class="n">option</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2022, Zhiyuan Ma.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.4.0. &nbsp;
    Last built 15 Feb 2022. <br/>
  </p>
</footer>
  </body>
</html>